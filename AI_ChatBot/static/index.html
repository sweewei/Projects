<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Êô∫ËÉΩÁáüÈ§äË´ÆË©¢Á≥ªÁµ±</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #e0e0e0;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
      margin: 0;
    }

    #chat-container {
      display: flex;
      flex-direction: column;
      width: min(90vw, 1000px);
      max-width: 1000px;
      min-width: 320px;
      height: 100vh;
      background: rgba(30, 30, 30, 0.95);
      backdrop-filter: blur(10px);
      border-radius: 20px;
      overflow: hidden;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      margin: 10px;
    }

    #chat-header {
      text-align: center;
      font-size: 22px;
      font-weight: 600;
      padding: 20px;
      background: linear-gradient(135deg, #2c3e50, #3498db);
      border-bottom: 1px solid #333;
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }

    #status-indicator {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: #27ae60;
      box-shadow: 0 0 10px rgba(39, 174, 96, 0.5);
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    #chat-box {
      flex: 1;
      background: rgba(30, 30, 30, 0.8);
      padding: 20px;
      overflow-y: auto;
      overflow-x: hidden;
      display: flex;
      flex-direction: column;
      gap: 15px;
      scrollbar-width: none;
      -ms-overflow-style: none;
    }

    #chat-box::-webkit-scrollbar {
      display: none;
    }

    .message-row {
      display: flex;
      align-items: flex-end;
      margin: 8px 0;
      animation: slideIn 0.3s ease-out;
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .message-row.user {
      justify-content: flex-end;
    }

    .message-row.bot {
      justify-content: flex-start;
    }

    .message {
      padding: 15px 20px;
      border-radius: 20px;
      max-width: 75%;
      line-height: 1.5em;
      word-wrap: break-word;
      position: relative;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
      margin-bottom: 8px;
    }

    .user .message {
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: #fff;
      margin-right: 10px;
      border-bottom-right-radius: 5px;
    }

    .bot .message {
      background: linear-gradient(135deg, #2c3e50, #34495e);
      color: #ecf0f1;
      margin-left: 10px;
      border-bottom-left-radius: 5px;
      border-left: 4px solid #3498db;
    }

    .message-timestamp {
      font-size: 11px;
      color: rgba(255, 255, 255, 0.5);
      margin-top: 4px;
      line-height: 1.2;
    }

    .user .message-timestamp {
      text-align: right;
      margin-right: 10px;
    }

    .bot .message-timestamp {
      text-align: left;
      margin-left: 10px;
    }

    .avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      margin: 0 8px;
      border: 2px solid rgba(255, 255, 255, 0.2);
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
    }

    .loading-container {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 15px 20px;
    }

    .loading-dots {
      display: flex;
      gap: 4px;
    }

    .loading-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #3498db;
      animation: loadingPulse 1.4s ease-in-out infinite both;
    }

    .loading-dot:nth-child(1) { animation-delay: -0.32s; }
    .loading-dot:nth-child(2) { animation-delay: -0.16s; }
    .loading-dot:nth-child(3) { animation-delay: 0s; }

    @keyframes loadingPulse {
      0%, 80%, 100% {
        transform: scale(0.8);
        opacity: 0.5;
      }
      40% {
        transform: scale(1);
        opacity: 1;
      }
    }

    hr.divider {
      border: none;
      border-top: 2px solid rgba(255, 255, 255, 0.1);
      margin: 30px 0 10px 0;
      width: 100%;
    }

    .restart-label {
      text-align: center;
      color: rgba(255, 255, 255, 0.5);
      font-size: 14px;
      margin-bottom: 20px;
      font-style: italic;
    }

    #faq-container {
      padding: 20px;
      background: linear-gradient(135deg, rgba(52, 152, 219, 0.1), rgba(155, 89, 182, 0.1));
      border-top: 1px solid rgba(255, 255, 255, 0.1);
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      display: none;
      animation: slideDown 0.4s ease-out;
      backdrop-filter: blur(5px);
    }

    #faq-container.show {
      display: block;
    }

    .faq-title {
      color: rgba(255, 255, 255, 0.9);
      font-size: 15px;
      font-weight: 600;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .faq-subtitle {
      color: rgba(255, 255, 255, 0.6);
      font-size: 13px;
      margin-bottom: 15px;
      font-style: italic;
    }

    .faq-questions {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .faq-btn {
      padding: 15px 20px;
      border: none;
      border-radius: 15px;
      background: linear-gradient(135deg, rgba(52, 152, 219, 0.8), rgba(46, 204, 113, 0.8));
      color: white;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.3s ease;
      border: 1px solid rgba(255, 255, 255, 0.2);
      text-align: left;
      line-height: 1.4;
      font-weight: 500;
      backdrop-filter: blur(10px);
    }

    .faq-btn:hover {
      background: linear-gradient(135deg, rgba(52, 152, 219, 1), rgba(46, 204, 113, 1));
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(52, 152, 219, 0.4);
      border-color: rgba(255, 255, 255, 0.4);
    }

    .faq-btn::before {
      content: "üí¨";
      margin-right: 10px;
      font-size: 16px;
    }

    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateY(-20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    #input-area {
      display: flex;
      align-items: flex-end;
      padding: 20px;
      background: rgba(40, 40, 40, 0.9);
      border-top: 1px solid rgba(255, 255, 255, 0.1);
      gap: 12px;
    }

    #user-input {
      flex: 1;
      padding: 15px 20px;
      border-radius: 25px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      outline: none;
      font-size: 16px;
      background: rgba(60, 60, 60, 0.8);
      color: #e0e0e0;
      resize: none;
      line-height: 1.5em;
      min-height: 50px;
      max-height: 120px;
      transition: all 0.3s ease;
    }

    #user-input:focus {
      border-color: #3498db;
      box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
      background: rgba(70, 70, 70, 0.9);
    }

    #user-input::placeholder {
      color: rgba(255, 255, 255, 0.4);
    }

    .btn {
      padding: 15px 25px;
      border: none;
      border-radius: 25px;
      font-weight: 600;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 8px;
      min-width: 120px;
      justify-content: center;
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
    }

    .btn:active {
      transform: translateY(0);
    }

    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    #send-btn {
      background: linear-gradient(135deg, #27ae60, #2ecc71);
      color: white;
    }

    #send-btn:hover:not(:disabled) {
      background: linear-gradient(135deg, #2ecc71, #27ae60);
    }

    #clear-btn {
      background: linear-gradient(135deg, #e74c3c, #c0392b);
      color: white;
    }

    #clear-btn:hover:not(:disabled) {
      background: linear-gradient(135deg, #ec7063, #e74c3c);
    }

    #stop-btn {
      background: linear-gradient(135deg, #f39c12, #e67e22);
      color: white;
      display: none;
    }

    #stop-btn:hover:not(:disabled) {
      background: linear-gradient(135deg, #f4d03f, #f39c12);
    }

    .error-message {
      background: linear-gradient(135deg, #e74c3c, #c0392b);
      color: white;
      padding: 15px 20px;
      border-radius: 15px;
      margin: 10px 0;
      border-left: 4px solid #fff;
      animation: shake 0.5s ease-in-out;
    }

    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-5px); }
      75% { transform: translateX(5px); }
    }

    /* ÈüøÊáâÂºèË®≠Ë®à */
    @media (max-width: 768px) {
      #chat-container {
        width: 100vw;
        height: 100vh;
        margin: 0;
        border-radius: 0;
      }

      .message {
        max-width: 85%;
        padding: 12px 16px;
      }

      #input-area {
        padding: 15px;
        flex-wrap: wrap;
      }

      .btn {
        min-width: 100px;
        padding: 12px 20px;
        font-size: 13px;
      }

      #user-input {
        font-size: 16px;
      }
    }

    @media (max-width: 480px) {
      .faq-questions {
        flex-direction: column;
      }

      .faq-btn {
        width: 100%;
        text-align: center;
      }

      #input-area {
        flex-direction: column;
        gap: 8px;
      }

      .btn {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <div id="chat-container">
    <!-- È†≠ÈÉ® -->
    <div id="chat-header">
      <i class="fas fa-robot"></i>
      Êô∫ËÉΩÁáüÈ§äË´ÆË©¢Á≥ªÁµ±
      <div id="status-indicator"></div>
    </div>

    <!-- ËÅäÂ§©ÂçÄÂüü -->
    <div id="chat-box"></div>

    <!-- FAQ ÂçÄÂüü -->
    <div id="faq-container">
      <div class="faq-title">
        <i class="fas fa-lightbulb"></i>
        Â∏∏Ë¶ãÂïèÈ°å
      </div>
      <div class="faq-subtitle">ÈÅ∏Êìá‰∏ÄÂÄãÂïèÈ°åÈñãÂßãÂ∞çË©±ÔºåÊàñÁõ¥Êé•Âú®‰∏ãÊñπËº∏ÂÖ•ÊÇ®ÁöÑÂïèÈ°å</div>
      <div class="faq-questions" id="faq-questions"></div>
    </div>

    <!-- Ëº∏ÂÖ•ÂçÄÂüü -->
    <div id="input-area">
      <textarea 
        id="user-input" 
        rows="1" 
        placeholder="Ë´ãËº∏ÂÖ•ÊÇ®ÁöÑÁáüÈ§äÂïèÈ°å...ÔºàEnterÈÄÅÂá∫ÔºåShift+EnterÊèõË°åÔºâ"
        maxlength="1000"
      ></textarea>
      
      <button id="send-btn" class="btn" onclick="sendMessage()">
        <i class="fas fa-paper-plane"></i>
        ÈÄÅÂá∫
      </button>
      
      <button id="clear-btn" class="btn" onclick="clearChat()">
        <i class="fas fa-refresh"></i>
        ÈáçÊñ∞Â∞çË©±
      </button>
      
      <button id="stop-btn" class="btn" onclick="stopOutput()">
        <i class="fas fa-stop"></i>
        ÂÅúÊ≠¢
      </button>
    </div>
  </div>

  <script>
    class ChatSystem {
      constructor() {
        this.elements = {
          input: document.getElementById("user-input"),
          sendBtn: document.getElementById("send-btn"),
          clearBtn: document.getElementById("clear-btn"),
          stopBtn: document.getElementById("stop-btn"),
          chatBox: document.getElementById("chat-box"),
          faqContainer: document.getElementById("faq-container"),
          faqQuestions: document.getElementById("faq-questions"),
          statusIndicator: document.getElementById("status-indicator")
        };
        
        this.state = {
          isTyping: false,
          typingInterval: null,
          fullReply: "",
          chatHistory: 0,
          lastInteractionTime: null
        };
        
        this.config = {
          apiBase: "http://127.0.0.1:8000",
          typingSpeed: 30,
          maxInputLength: 1000,
          faqTimeout: 60000 // 60ÁßíË∂ÖÊôÇÈ°ØÁ§∫FAQ
        };
        
        this.faqTimer = null;
        this.faqQuestions = [
          "ÈÄôÂÄãÁî¢ÂìÅÈÅ©ÂêàÁ≥ñÂ∞øÁóÖÊÇ£ËÄÖ‰ΩøÁî®ÂóéÔºü",
          "ÊúâÂì™‰∫õÁî¢ÂìÅÊúâÂä©ÊñºËÖ∏ËÉÉÂÅ•Â∫∑Ôºü", 
          "Âì™‰∫õÁî¢ÂìÅÊØîËºÉÈÅ©ÂêàÂ≠ïÂ©¶È£üÁî®Ôºü"
        ];
        
        this.init();
      }
      
      init() {
        this.loadChatHistory();
        this.setupEventListeners();
        this.startHealthCheck();
        
        // ÂàùÂßãÈ°ØÁ§∫FAQÔºàÊ®°Êì¨ÂàùÊ¨°Â∞çË©±Ôºâ
        setTimeout(() => {
          this.showInitialFAQ();
        }, 1000);
      }
      
      setupEventListeners() {
        // Ëº∏ÂÖ•Ê°Ü‰∫ã‰ª∂
        this.elements.input.addEventListener("keydown", (e) => {
          if (e.key === "Enter" && !e.shiftKey) {
            e.preventDefault();
            this.sendMessage();
          }
        });
        
        // Ëá™ÂãïË™øÊï¥Ëº∏ÂÖ•Ê°ÜÈ´òÂ∫¶
        this.elements.input.addEventListener("input", () => {
          this.autoResizeTextarea();
          this.updateCharCount();
          this.resetFAQTimer(); // Áî®Êà∂Ê¥ªÂãïÊôÇÈáçË®≠FAQË®àÊôÇÂô®
        });
        
        // Áî®Êà∂Ê¥ªÂãïÁõ£ËÅΩÔºàÈáçË®≠FAQË®àÊôÇÂô®Ôºâ
        ['click', 'keydown', 'mousemove'].forEach(event => {
          document.addEventListener(event, () => this.resetFAQTimer());
        });
        
        // Á™óÂè£ÈóúÈñâÂâç‰øùÂ≠ò
        window.addEventListener("beforeunload", () => {
          this.saveChatHistory();
        });
      }
      
      showInitialFAQ() {
        // Ê™¢Êü•ÊòØÂê¶ÊòØÂàùÊ¨°Â∞çË©±ÊàñÂ∞çË©±ÂæàÂ∞ë
        const messageCount = this.elements.chatBox.children.length;
        const hasUserMessages = this.elements.chatBox.querySelector('.message-row.user');
        
        if (messageCount < 3 || !hasUserMessages) {
          this.renderFAQ(this.faqQuestions);
          this.startFAQTimer();
        }
      }
      
      startFAQTimer() {
        this.clearFAQTimer();
        this.resetFAQTimer();
      }
      
      resetFAQTimer() {
        this.clearFAQTimer();
        
        // Â¶ÇÊûúFAQÂ∑≤Á∂ìÈ°ØÁ§∫Ôºå‰∏çË®≠ÂÆöÊñ∞Ë®àÊôÇÂô®
        if (this.elements.faqContainer.classList.contains('show')) {
          return;
        }
        
        // Ë®≠ÂÆöÊñ∞ÁöÑË∂ÖÊôÇË®àÊôÇÂô®
        this.faqTimer = setTimeout(() => {
          if (!this.elements.faqContainer.classList.contains('show')) {
            this.renderFAQ(this.faqQuestions);
          }
        }, this.config.faqTimeout);
      }
      
      clearFAQTimer() {
        if (this.faqTimer) {
          clearTimeout(this.faqTimer);
          this.faqTimer = null;
        }
      }
      
      autoResizeTextarea() {
        const textarea = this.elements.input;
        textarea.style.height = "auto";
        textarea.style.height = Math.min(textarea.scrollHeight, 120) + "px";
      }
      
      updateCharCount() {
        const length = this.elements.input.value.length;
        const maxLength = this.config.maxInputLength;
        
        if (length > maxLength * 0.9) {
          this.elements.input.style.borderColor = length >= maxLength ? "#e74c3c" : "#f39c12";
        } else {
          this.elements.input.style.borderColor = "rgba(255, 255, 255, 0.1)";
        }
      }
      
      renderFAQ(questions) {
        this.elements.faqQuestions.innerHTML = "";
        
        questions.forEach(question => {
          const btn = document.createElement("button");
          btn.className = "faq-btn";
          btn.textContent = question;
          btn.onclick = () => {
            this.hideFAQ();
            this.sendMessage(question);
          };
          this.elements.faqQuestions.appendChild(btn);
        });
        
        this.elements.faqContainer.classList.add("show");
      }
      
      hideFAQ() {
        this.elements.faqContainer.classList.remove("show");
        // Èö±ËóèÂæåÈáçÊñ∞ÈñãÂßãË®àÊôÇ
        setTimeout(() => {
          this.startFAQTimer();
        }, 1000);
      }
      
      async sendMessage(optionalMessage) {
        const message = optionalMessage || this.elements.input.value.trim();
        if (!message || this.state.isTyping) return;
        
        // Èö±ËóèFAQ‰∏¶Ê∏ÖÈô§Ë®àÊôÇÂô®
        this.hideFAQ();
        this.clearFAQTimer();
        
        // Ê∑ªÂä†Áî®Êà∂Ê∂àÊÅØÔºàÂ∏∂ÊôÇÈñìÊà≥Ôºâ
        this.addMessage(message, "user");
        this.elements.input.value = "";
        this.elements.input.style.height = "auto";
        
        // Êõ¥Êñ∞ UI ÁãÄÊÖã
        this.setTypingState(true);
        
        // È°ØÁ§∫ËºâÂÖ•ÂãïÁï´
        const loadingMsg = this.addLoadingMessage();
        
        try {
          const response = await fetch(`${this.config.apiBase}/chat`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ message })
          });
          
          if (!response.ok) {
            throw new Error(`‰º∫ÊúçÂô®ÈåØË™§ (${response.status})`);
          }
          
          const data = await response.json();
          
          // ÁßªÈô§ËºâÂÖ•ÂãïÁï´ÔºåÈñãÂßãÊâìÂ≠óÊïàÊûú
          this.removeLoadingMessage(loadingMsg);
          this.startTypingEffect(data.reply, data);
          
          this.updateConnectionStatus(true);
          
        } catch (error) {
          console.error("ÁôºÈÄÅË®äÊÅØÂ§±Êïó:", error);
          this.removeLoadingMessage(loadingMsg);
          this.addErrorMessage(error.message);
          this.setTypingState(false);
          this.updateConnectionStatus(false);
        }
      }
      
      addMessage(content, role) {
        const messageRow = document.createElement("div");
        messageRow.className = `message-row ${role}`;
        
        const avatar = role === "user" 
          ? "https://i.pravatar.cc/40?u=user" 
          : "https://i.pravatar.cc/40?u=bot";
        
        const avatarImg = `<img src="${avatar}" class="avatar" alt="${role}">`;
        const messageDiv = `<div class="message">${content}</div>`;
        
        // Ê∑ªÂä†ÊôÇÈñìÊà≥
        const now = new Date();
        const timeString = this.formatTimestamp(now);
        const timestampDiv = `<div class="message-timestamp">${timeString}</div>`;
        
        if (role === "user") {
          messageRow.innerHTML = messageDiv + timestampDiv + avatarImg;
        } else {
          messageRow.innerHTML = avatarImg + messageDiv + timestampDiv;
        }
        
        this.elements.chatBox.appendChild(messageRow);
        this.scrollToBottom();
        this.saveChatHistory();
        
        return messageRow;
      }
      
      formatTimestamp(date) {
        const now = new Date();
        const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
        const messageDate = new Date(date.getFullYear(), date.getMonth(), date.getDate());
        
        // Ê†ºÂºèÂåñÊôÇÈñì
        const timeStr = date.toLocaleTimeString('zh-TW', { 
          hour: '2-digit', 
          minute: '2-digit',
          hour12: false
        });
        
        // Âà§Êñ∑Êó•Êúü
        if (messageDate.getTime() === today.getTime()) {
          return `‰ªäÂ§©\n${timeStr}`;
        } else if (messageDate.getTime() === today.getTime() - 86400000) {
          return `Êò®Â§©\n${timeStr}`;
        } else {
          const dateStr = date.toLocaleDateString('zh-TW', {
            month: '2-digit',
            day: '2-digit'
          });
          return `${dateStr}\n${timeStr}`;
        }
      }
      
      addLoadingMessage() {
        const messageRow = document.createElement("div");
        messageRow.className = "message-row bot";
        messageRow.innerHTML = `
          <img src="https://i.pravatar.cc/40?u=bot" class="avatar" alt="bot">
          <div class="message">
            <div class="loading-container">
              <div class="loading-dots">
                <div class="loading-dot"></div>
                <div class="loading-dot"></div>
                <div class="loading-dot"></div>
              </div>
              <span style="margin-left: 8px; color: rgba(255,255,255,0.6);">ÊÄùËÄÉ‰∏≠...</span>
            </div>
          </div>
        `;
        
        this.elements.chatBox.appendChild(messageRow);
        this.scrollToBottom();
        
        return messageRow;
      }
      
      removeLoadingMessage(loadingMsg) {
        if (loadingMsg && loadingMsg.parentNode) {
          loadingMsg.parentNode.removeChild(loadingMsg);
        }
      }
      
      addErrorMessage(errorMsg) {
        const messageRow = document.createElement("div");
        messageRow.className = "message-row bot";
        messageRow.innerHTML = `
          <img src="https://i.pravatar.cc/40?u=bot" class="avatar" alt="bot">
          <div class="message error-message">
            <i class="fas fa-exclamation-triangle"></i>
            Êä±Ê≠âÔºåÁôºÁîü‰∫ÜÈåØË™§Ôºö${errorMsg}
          </div>
        `;
        
        this.elements.chatBox.appendChild(messageRow);
        this.scrollToBottom();
        this.saveChatHistory();
      }
      
      startTypingEffect(text, data) {
        const botMsgRow = this.addMessage("", "bot");
        const botMsgDiv = botMsgRow.querySelector(".message");
        
        this.state.fullReply = text;
        let index = 0;
        const speed = text.length > 500 ? 2 : 1;
        
        this.state.typingInterval = setInterval(() => {
          if (index < text.length && this.state.isTyping) {
            const chunk = text.slice(index, index + speed);
            botMsgDiv.textContent += chunk;
            index += speed;
            this.scrollToBottom();
            this.saveChatHistory();
          } else {
            this.finishTyping(botMsgDiv, data);
          }
        }, this.config.typingSpeed);
      }
      
      finishTyping(msgDiv, data) {
        clearInterval(this.state.typingInterval);
        this.state.typingInterval = null;
        msgDiv.textContent = this.state.fullReply;
        this.setTypingState(false);
        this.saveChatHistory();
        
        // ÂÆåÊàêÂæåÈáçÊñ∞ÈñãÂßãFAQË®àÊôÇ
        this.resetFAQTimer();
      }
      
      stopOutput() {
        if (this.state.typingInterval) {
          // Á´ãÂç≥ÂÅúÊ≠¢ÊâìÂ≠óÊïàÊûú
          clearInterval(this.state.typingInterval);
          this.state.typingInterval = null;
          
          // Áç≤ÂèñÁï∂ÂâçÊ≠£Âú®ÊâìÂ≠óÁöÑÊ∂àÊÅØ
          const lastBotMsg = this.elements.chatBox.querySelector(".message-row.bot:last-child .message");
          if (lastBotMsg) {
            // ‰øùÊåÅÁï∂ÂâçÂÖßÂÆπÔºåÊ∑ªÂä†ÂÅúÊ≠¢Ê®ôË®ò
            const currentContent = lastBotMsg.textContent;
            lastBotMsg.innerHTML = currentContent + '<span style="color: rgba(255,255,255,0.5); font-style: italic; margin-left: 8px;">[Â∑≤ÂÅúÊ≠¢]</span>';
          }
          
          // Á´ãÂç≥ÈáçË®≠UIÁãÄÊÖã
          this.setTypingState(false);
          this.saveChatHistory();
          
          // ÂÅúÊ≠¢ÂæåÈáçÊñ∞ÈñãÂßãFAQË®àÊôÇ
          this.resetFAQTimer();
        }
      }
      
      setTypingState(isTyping) {
        this.state.isTyping = isTyping;
        this.elements.input.disabled = isTyping;
        
        if (isTyping) {
          this.elements.sendBtn.style.display = "none";
          this.elements.clearBtn.style.display = "none";
          this.elements.stopBtn.style.display = "flex";
          
          // ÊâìÂ≠óÊôÇÊö´ÂÅúFAQË®àÊôÇÂô®
          this.clearFAQTimer();
        } else {
          this.elements.sendBtn.style.display = "flex";
          this.elements.clearBtn.style.display = "flex";
          this.elements.stopBtn.style.display = "none";
          this.elements.input.focus();
        }
      }
      
      async clearChat() {
        const now = new Date();
        const dateStr = now.toLocaleString("zh-TW");
        
        // ÂÅúÊ≠¢‰ªª‰ΩïÈÄ≤Ë°å‰∏≠ÁöÑÊâìÂ≠óÊïàÊûú
        if (this.state.typingInterval) {
          clearInterval(this.state.typingInterval);
          this.state.typingInterval = null;
        }
        
        // ÈáçË®≠ÁãÄÊÖã
        this.setTypingState(false);
        
        this.elements.chatBox.innerHTML += `
          <hr class="divider">
          <div class="restart-label">
            <i class="fas fa-redo" style="margin-right: 8px;"></i>
            ÈáçÊñ∞Â∞çË©± ‚Ä¢ ${dateStr}
          </div>
        `;
        
        this.scrollToBottom();
        this.state.chatHistory = 0;
        
        // Ê∏ÖÈô§ÊâÄÊúâË®àÊôÇÂô®
        this.clearFAQTimer();
        
        // ÂÖàÈö±ËóèFAQ
        this.elements.faqContainer.classList.remove("show");
        
        try {
          await fetch(`${this.config.apiBase}/reset`, { method: "POST" });
          this.updateConnectionStatus(true);
        } catch (error) {
          console.error("ÈáçÁΩÆÂ§±Êïó:", error);
          this.updateConnectionStatus(false);
        }
        
        // Âº∑Âà∂È°ØÁ§∫FAQÔºàÈáçÊñ∞Â∞çË©±ÂæåÂøÖÈ†àÈ°ØÁ§∫Ôºâ
        setTimeout(() => {
          this.renderFAQ(this.faqQuestions);
          this.startFAQTimer();
        }, 1000);
      }
      
      scrollToBottom() {
        this.elements.chatBox.scrollTop = this.elements.chatBox.scrollHeight;
      }
      
      saveChatHistory() {
        try {
          localStorage.setItem("chatHistory", this.elements.chatBox.innerHTML);
        } catch (error) {
          console.warn("ÁÑ°Ê≥ï‰øùÂ≠òËÅäÂ§©Ë®òÈåÑ:", error);
        }
      }
      
      loadChatHistory() {
        try {
          const saved = localStorage.getItem("chatHistory");
          if (saved) {
            this.elements.chatBox.innerHTML = saved;
            this.scrollToBottom();
          }
        } catch (error) {
          console.warn("ÁÑ°Ê≥ïËºâÂÖ•ËÅäÂ§©Ë®òÈåÑ:", error);
        }
      }
      
      updateConnectionStatus(isConnected) {
        const indicator = this.elements.statusIndicator;
        if (isConnected) {
          indicator.style.background = "#27ae60";
          indicator.style.boxShadow = "0 0 10px rgba(39, 174, 96, 0.5)";
        } else {
          indicator.style.background = "#e74c3c";
          indicator.style.boxShadow = "0 0 10px rgba(231, 76, 60, 0.5)";
        }
      }
      
      async startHealthCheck() {
        const check = async () => {
          try {
            const response = await fetch(`${this.config.apiBase}/health`);
            this.updateConnectionStatus(response.ok);
          } catch {
            this.updateConnectionStatus(false);
          }
        };
        
        check();
        setInterval(check, 30000); // 30ÁßíÊ™¢Êü•‰∏ÄÊ¨°
      }
    }
    
    // ÂÖ®ÂüüÂáΩÊï∏ÔºàÂêëÂæåÁõ∏ÂÆπÔºâ
    let chatSystem;
    
    window.onload = () => {
      chatSystem = new ChatSystem();
    };
    
    function sendMessage(message) {
      chatSystem?.sendMessage(message);
    }
    
    function clearChat() {
      chatSystem?.clearChat();
    }
    
    function stopOutput() {
      chatSystem?.stopOutput();
    }
  </script>
</body>
</html>